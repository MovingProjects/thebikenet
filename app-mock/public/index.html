<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>theBIKEnet</title>

    <!-- External Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

    <!-- Modular Styles -->
    <link rel="stylesheet" href="styles/map.css" />
    <link rel="stylesheet" href="styles/history.css" />
    <link rel="stylesheet" href="styles/profile.css" />
    <link rel="stylesheet" href="styles/vehicle.css" />
    <link rel="stylesheet" href="styles/socio_demo.css" />

    <!-- General Layout (e.g. .phone-frame, .bottom-bar) -->
    <link rel="stylesheet" href="styles/style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<body>
    <div class="app-container">
        <div class="app-wrapper">
            <div class="test-controls">
                <button>Test Button 1</button>
                <button>Test Button 2</button>
                <button onclick="runMockupFlow()">ðŸ¤– Esegui flow automatico</button>
            </div>
        </div>
        <div class="phone-frame">

            <!-- MAP SCREEN -->
            <div class="map-screen" id="map-screen">
                <div id="map"></div>
                <div class="top-buttons">
                    <button id="locate-btn" title="Geolocalizza"><i class="bi bi-geo-alt-fill"></i></button>
                    <button id="legend-btn" title="Legenda"><i class="bi bi-info-circle-fill"></i></button>
                </div>
                <div class="legend-modal" id="legend-modal">
                    <div class="legend-content">
                        <button class="legend-close" id="legend-close" title="Chiudi">&times;</button>
                        <iframe src="https://www.cyclosm.org/legend.html"></iframe>
                    </div>
                </div>
                <button class="map-button" title="Avvia registrazione"><i class="bi bi-play-fill"></i></button>
            </div>

            <!-- HISTORY SCREEN -->
            <div class="history-screen" id="history-screen">
                <h3>Storico Percorsi</h3>
                <div class="history-item">
                    <h4>Giro al Parco</h4>
                    <p>Data: 01/05/2025</p>
                    <p>Distanza: 12.5 km</p>
                    <p>Durata: 45 min</p>
                </div>
                <div class="history-item">
                    <h4>Centro Storico</h4>
                    <p>Data: 25/04/2025</p>
                    <p>Distanza: 8.2 km</p>
                    <p>Durata: 30 min</p>
                </div>
            </div>

            <!-- PROFILE SCREEN -->
            <div class="profile-screen" id="profile-screen">
                <h3 id="user-name">Mario Rossi</h3>
                <div class="profile-info">
                    <span id="email-text">caricamento...</span>
                </div>

                <div class="profile-actions">
                    <button id="open-sociodemo-btn">Completa le tue informazioni</button>
                    <button id="logout-btn">Esci</button>
                </div>

                <div class="vehicles-header">
                    <h4>I miei veicoli</h4>
                    <button id="add-vehicle-btn">Aggiungi un veicolo</button>
                </div>
                <div class="vehicle-list-container">
                    <div class="vehicle-list" id="vehicle-list"></div>
                </div>
            </div>

            <!-- VEHICLE SCREEN -->
            <div class="vehicle-screen" id="vehicle-screen" style="display: none;">
                <h3>Nuovo veicolo</h3>

                <div class="form-row">
                    <label for="vehicle-name">Nome veicolo:</label>
                    <input type="text" id="vehicle-name" />
                </div>

                <div class="form-row">
                    <label for="vehicle-type">Tipo veicolo:</label>
                    <select id="vehicle-type">
                        <option value="city_bike">Bicicletta da cittÃ </option>
                        <option value="sport_bike">Bicicletta sportiva</option>
                        <option value="folding_bike">Bicicletta pieghevole</option>
                        <option value="cargo_bike">Bicicletta cargo</option>
                        <option value="scooter">Monopattino</option>
                        <option value="other">Altro</option>
                    </select>
                </div>

                <div class="form-row">
                    <label for="vehicle-color">Colore:</label>
                    <input type="color" id="vehicle-color" value="#9ED9C0" />
                </div>

                <div class="form-row">
                    <label class="checkbox-inline">
                        <span>Ãˆ elettrico?</span>
                        <input type="checkbox" id="vehicle-electric" />
                    </label>
                </div>

                <div class="form-row">
                    <label class="checkbox-inline">
                        <span>Imposta come principale</span>
                        <input type="checkbox" id="vehicle-default" />
                    </label>
                </div>

                <div class="form-actions">
                    <button id="submit-add-vehicle" class="btn-primary">Salva</button>
                    <button id="cancel-add-vehicle" class="btn-secondary">Annulla</button>
                </div>
            </div>

            <!-- SOCIODEMOGRAPHIC SCREEN -->
            <div class="sociodemo-screen" id="sociodemo-screen" style="display: none;">
                <h3>Questionario Sociodemografico</h3>
                <div id="sociodemo-questions"></div>
                <div class="form-actions">
                    <button id="submit-sociodemo" class="btn-primary">Salva</button>
                    <button id="cancel-sociodemo" class="btn-secondary">Annulla</button>
                </div>
            </div>

            <!-- BOTTOM NAVIGATION -->
            <div class="bottom-bar">
                <button class="active" id="map-tab" title="Mappa"><i class="bi bi-map"></i></button>
                <button id="history-tab" title="Storico"><i class="bi bi-layout-text-sidebar-reverse"></i></button>
                <button id="profile-tab" title="Profilo"><i class="bi bi-person-circle"></i></button>
            </div>
        </div>

        <!-- JS Scripts -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script
            src="https://rawcdn.githack.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>
        <script src="navigation.js"></script>
        <script src="screens/map.js"></script>
        <script src="screens/history.js"></script>
        <script src="screens/vehicle.js"></script>
        <script src="screens/socio_demo.js"></script>
        <script src="screens/profile.js"></script>

        <script>
            let mockupCounter = 1; // numerazione file .png

            function showScreen(screenId, skipMock = false) {
                const screens = [
                    "map-screen",
                    "history-screen",
                    "profile-screen",
                    "vehicle-screen",
                    "sociodemo-screen",
                ];

                screens.forEach((id) => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = id === screenId ? "block" : "none";
                });

                if (!skipMock) {
                    setTimeout(() => {
                        const filename = `${String(mockupCounter).padStart(2, "0")}-${screenId.replace("-screen", "")}.png`;
                        captureMockup(filename);
                        mockupCounter++;
                    }, 300); // attende rendering della schermata
                }
            }

            function captureMockup(fileName = "mockup.png") {
                const phoneFrame = document.querySelector(".phone-frame");
                if (!phoneFrame) return;

                html2canvas(phoneFrame, {
                    backgroundColor: null,
                    useCORS: true,
                    scale: 3, // alta qualitÃ  per poster
                }).then((canvas) => {
                    canvas.toBlob((blob) => {
                        const link = document.createElement("a");
                        link.download = fileName;
                        link.href = URL.createObjectURL(blob);
                        link.click();
                    }, "image/png");
                });
            }

            function applyRoundedMask(canvas, radius) {
                const maskedCanvas = document.createElement("canvas");
                maskedCanvas.width = canvas.width;
                maskedCanvas.height = canvas.height;

                const ctx = maskedCanvas.getContext("2d");
                ctx.drawImage(canvas, 0, 0);

                ctx.globalCompositeOperation = "destination-in";
                ctx.beginPath();
                ctx.roundRect(0, 0, canvas.width, canvas.height, radius);
                ctx.fill();

                return maskedCanvas;
            }


            async function runMockupFlow() {
                const screens = [
                    "map-screen",
                    "history-screen",
                    "profile-screen",
                    "vehicle-screen",
                    "sociodemo-screen",
                ];

                const zip = new JSZip();

                for (let i = 0; i < screens.length; i++) {
                    const screenId = screens[i];
                    showScreen(screenId, true); // mostra schermata
                    await new Promise((res) => setTimeout(res, 800)); // attende rendering

                    const phoneFrame = document.querySelector(".phone-frame");
                    const scale = 3;

                    const canvas = await html2canvas(phoneFrame, {
                        backgroundColor: "white", // ðŸ”³ sfondo bianco fisso
                        useCORS: true,
                        scale,
                    });

                    // (FACOLTATIVO) Maschera angoli curvi veri
                    const radius = 60 * scale;
                    const maskedCanvas = applyRoundedMask(canvas, radius);

                    const blob = await new Promise((res) =>
                        maskedCanvas.toBlob(res, "image/png")
                    );

                    const filename = `${String(mockupCounter).padStart(2, "0")}-${screenId.replace("-screen", "")}.png`;
                    zip.file(filename, blob);
                    mockupCounter++;

                    await new Promise((res) => setTimeout(res, 500));
                }

                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, "mockup.zip");

                alert("âœ… ZIP creato con successo!");
            }


        </script>
</body>
</div>

</html>