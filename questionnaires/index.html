<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>theBIKEnet ‚Äì Questionari</title>

    <!-- Metadata uniformati -->
    <meta name="description"
      content="Elenco dei questionari del progetto theBIKEnet, con caricamento automatico da GitHub e supporto multilingua.">
    <meta name="author" content="Moving Projects Srl" />
    <meta name="robots" content="index, follow" />
    <meta name="theme-color" content="#0C9091" />

    <!-- Open Graph -->
    <meta property="og:title" content="theBIKEnet ‚Äì Questionnaires" />
    <meta property="og:description"
      content="Explore the official theBIKEnet questionnaires on cycling behaviour, perceptions, context, safety and mobility." />
    <meta property="og:type" content="website" />
    <meta property="og:image"
      content="https://movingprojects.github.io/thebikenet/docs/assets/theBIKEnet_logo.png" />
    <meta property="og:url"
      content="https://movingprojects.github.io/thebikenet/questionnaires/index.html" />

    <meta name="twitter:description"
      content="Explore the official theBIKEnet questionnaires on cycling behaviour, perceptions, context, safety and mobility." />
    <link rel="apple-touch-icon"
      href="https://movingprojects.github.io/thebikenet/docs/assets/theBIKEnet_logo.png" />

    <!-- Favicons -->
    <link rel="icon"
      href="https://movingprojects.github.io/thebikenet/docs/assets/theBIKEnet_logo.png"
      type="image/png" />

    <!-- Skip link accessibility style (minimal, resto via loader) -->
    <style>
:focus-visible { outline: 3px solid #F2AD2B; outline-offset: 3px; }
.skip-link {
position:absolute; top:0; left:0; background:#0C9091; color:#fff;
padding:0.6rem 1rem; border-radius:0 0 6px 0;
transform:translateY(-120%); transition:transform .3s ease;
z-index:100;
}
.skip-link:focus { transform:translateY(0); }
</style>
  </head>

  <body>
    <a href="#maincontent" class="skip-link">Skip to main content</a>

    <!-- Header injected via template loader -->
    <div id="bikenet-header"></div>

    <!-- MAIN CONTENT -->
    <main id="maincontent" tabindex="-1" role="main"
      aria-label="Questionnaires list">

      <!-- üáÆüáπ ITALIANO -->
      <div data-lang="it" lang="it">
        <section>
          <h2>I questionari di theBIKEnet</h2>
          <p>
            Il sistema di rilevazione del progetto <strong>theBIKEnet</strong>
            utilizza
            otto questionari tematici, disponibili in italiano e inglese,
            pensati per
            capire come le persone si muovono in bici e come vivono la sicurezza
            sulle strade della citt√†.
          </p>

          <p>
            Ogni questionario affronta un aspetto diverso dell‚Äôesperienza in
            bicicletta:
            chi pedala, in quali contesti si muove, quanto si sente sicuro,
            quali
            comportamenti adotta, quali difficolt√† incontra e come cambiano le
            sue
            abitudini nel tempo. Le risposte sono anonime, trattate nel rispetto
            del
            GDPR, e collegate solo attraverso un codice partecipante che non
            permette
            l‚Äôidentificazione.
          </p>

          <p>
            Le informazioni raccolte contribuiscono a creare un quadro completo
            della
            ciclabilit√† urbana: profilo dei ciclisti, abitudini di viaggio,
            percezione
            della sicurezza, episodi di rischio, uso dei servizi di mobilit√†,
            opinioni
            e motivazioni, insieme ai diari di viaggio prima e dopo
            l‚Äôesperienza.
            Questi dati ci aiutano a comprendere dove si pedala, come ci si
            sente,
            quali problemi si incontrano e quali soluzioni possono migliorare la
            rete
            ciclabile della citt√†.
          </p>
        </section>

      </div>

      <!-- ENGLISH VERSION -->
      <div data-lang="en" lang="en">
        <section>
          <h2>theBIKEnet questionnaires</h2>
          <p>
            The <strong>theBIKEnet</strong> survey system includes eight
            thematic
            bilingual questionnaires designed to understand how people cycle in
            the
            city: where they travel, how safe they feel, which situations are
            challenging, and how their habits change over time.
          </p>

          <p>
            Each module focuses on a different aspect of everyday cycling: who
            cycles,
            travel patterns, safety perception, personal safety behaviour,
            experiences
            of near misses or accidents, available mobility services, attitudes
            and
            motivations, and pre‚Äìpost trip diaries. All responses are anonymous,
            GDPR-compliant, and linked only through a non-identifying
            participant key.
          </p>

          <p>
            Together, these modules provide a comprehensive picture of urban
            cycling:
            users, places, behaviours, perceptions, risks, and motivations. The
            data
            help identify where people feel safe or exposed, which barriers
            prevent
            cycling, and what improvements can make the city‚Äôs cycling network
            more
            accessible and comfortable for everyone.
          </p>
        </section>

      </div>

      <!-- LISTA QUESTIONARI -->
      <section aria-label="Elenco questionari GitHub">
        <div id="q-list" class="q-grid">
          <div class="q-placeholder"></div>
          <div class="q-placeholder"></div>
          <div class="q-placeholder"></div>
        </div>
      </section>
    </main>

    <!-- Footer via template loader -->
    <div id="bikenet-footer"></div>

    <!-- Loader template/stile/lingua -->
    <script src="../docs/assets/theBIKEnet-web-init.js"></script>

    <!-- GitHub Questionnaire Loader  -->
    <script> 
  const OWNER = "MovingProjects";
  const REPO = "thebikenet";
  const PATH = "questionnaires";

  // üîó Base URL dell'app che espone i questionari da compilare
  // Risultato finale: `${FORM_BASE_URL}/${projectId}/${questId}`
  const FORM_BASE_URL = "https://thebikenet-rome-questionnaires.wemolab.eu/"; // TODO: sostituisci col tuo dominio

  const BASE_URL = `https://raw.githubusercontent.com/MovingProjects/thebikenet/main/questionnaires/surveys`;

  async function fetchIndex() {
    const res = await fetch(`${BASE_URL}/index.json`);
    if (!res.ok) throw new Error("Cannot load questionnaires/index.json");
    return res.json();
  }

  async function fetchQuestionnaire(filename) {
    const url = `${BASE_URL}/${filename}`  
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Cannot load ${filename}`);
    return res.json();
  }

  async function renderList() {
    const grid = document.getElementById("q-list");
    if (!grid) return;

    grid.innerHTML = `
      <div class="q-placeholder"></div>
      <div class="q-placeholder"></div>
      <div class="q-placeholder"></div>
    `;

    try {
      const data = await fetchIndex();
      const list = data.questionnaires || [];
      const projectId =
        data.destination &&
        data.destination.firestore &&
        data.destination.firestore.projectId
          ? data.destination.firestore.projectId
          : null;

      grid.innerHTML = "";

      for (const filename of list) {
        const baseName = filename.replace(".json", "");
          const viewLink = `https://github.com/MovingProjects/thebikenet/blob/main/questionnaires/surveys/${filename}`;
        const questionnaireUrl =
          FORM_BASE_URL
            ? `${FORM_BASE_URL}quest?id=${baseName}`
            : null; 

console.log(questionnaireUrl);

        let titleEn = baseName;
        let titleIt = baseName;
        let descEn = "";
        let descIt = "";

        try {
          const qJson = await fetchQuestionnaire(filename);
          const qDef = qJson.questionnaire || {};
          const sections = qDef.sections || [];
          const languages = qJson.languages || {};
          const itMap = languages.it || {};

          if (qDef.name) {
            titleEn = qDef.name;
          }

          const itTitleKey = qDef.name ? "#" + qDef.name : null;
          if (itTitleKey && itMap[itTitleKey]) {
            titleIt = itMap[itTitleKey];
          } else {
            titleIt = titleEn;
          }

          if (sections.length > 0) {
            descEn =
              sections[0].description ||
              sections[0].title ||
              "Structured questionnaire about cycling and urban mobility.";
          } else {
            descEn =
              qDef.name ||
              "Structured questionnaire about cycling and urban mobility.";
          }

          const itDescKey = "#" + descEn;
          if (itMap[itDescKey]) {
            descIt = itMap[itDescKey];
          } else {
            descIt = descEn;
          }
        } catch (err) {
          console.warn(`Error parsing questionnaire ${filename}`, err);
          titleEn = baseName;
          titleIt = baseName;
          descEn = "Structured questionnaire definition.";
          descIt = "Definizione strutturata del questionario.";
        }

        const card = document.createElement("div");
        card.className = "q-card";

        card.innerHTML = `
          <div>
            <h3>
              <span data-lang="it">${titleIt}</span>
              <span data-lang="en">${titleEn}</span>
            </h3>

            <div class="q-description">
             <button type="button" class="q-toggle" aria-expanded="false">
  <span class="q-toggle-icon">‚ñº</span>
  <span data-lang="it">Descrizione</span>
  <span data-lang="en">Description</span>
</button>

              <div class="q-desc-body" hidden>
                <p data-lang="it">${descIt}</p>
                <p data-lang="en">${descEn}</p>
              </div>
            </div>
          </div>

          <div class="q-card-links">           
            ${
              questionnaireUrl
                ? `
            <a href="${questionnaireUrl}" target="_blank" rel="noopener">
              <span data-lang="it">üìù Rispondi al questionario</span>
              <span data-lang="en">üìù Fill in the questionnaire</span>
            </a>`
                : ""
            }
			
			<a href="${viewLink}" target="_blank" rel="noopener">
              <span data-lang="it">üìÑ Vedi schema JSON</span>
              <span data-lang="en">üìÑ View JSON schema</span>
            </a>
          </div>
        `;

        // toggle descrizione
        const toggleBtn = card.querySelector(".q-toggle");
        const descBody = card.querySelector(".q-desc-body");
        if (toggleBtn && descBody) {
          toggleBtn.addEventListener("click", () => {
            const isExpanded = toggleBtn.getAttribute("aria-expanded") === "true";
            toggleBtn.setAttribute("aria-expanded", String(!isExpanded));
            descBody.hidden = isExpanded;

            const labelIt = toggleBtn.querySelector('span[data-lang="it"]');
            const labelEn = toggleBtn.querySelector('span[data-lang="en"]');
           if (!isExpanded) {
  // ora si espande, quindi il testo diventa ‚ÄúNascondi / Hide‚Äù
  if (labelIt) labelIt.textContent = "Nascondi";
  if (labelEn) labelEn.textContent = "Hide";
} else {
  // ora si chiude
  if (labelIt) labelIt.textContent = "Descrizione";
  if (labelEn) labelEn.textContent = "Description";
}

          });
        }

        grid.appendChild(card);
      }

      if (!grid.hasChildNodes()) {
        grid.innerHTML = `
          <p data-lang="it">Nessun questionario trovato.</p>
          <p data-lang="en">No questionnaires found.</p>
        `;
      }

      // ‚úÖ riapplica il filtro lingua dopo aver creato le card
      if (window.setLang && window.currentLang) {
        window.setLang(window.currentLang);
      }
    } catch (err) {
      console.error(err);
      grid.innerHTML = `
        <p data-lang="it">Errore nel caricamento dei questionari.</p>
        <p data-lang="en">Error loading questionnaires.</p>
      `;
    }
  }

  document.addEventListener("DOMContentLoaded", renderList);
</script>

  </body>
</html>
